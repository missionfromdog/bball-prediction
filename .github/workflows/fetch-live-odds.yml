name: Fetch Live NBA Odds

on:
  # Run every 6 hours during NBA season
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  
  # Allow manual trigger
  workflow_dispatch:

# Grant write permissions
permissions:
  contents: write

jobs:
  fetch-odds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: false
          ref: main
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests
      
      - name: Fetch Live Odds from The Odds API
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          echo "ðŸŽ² Fetching live NBA odds from The Odds API..."
          python scripts/data_collection/scrape_live_odds.py
        continue-on-error: false  # Fail if odds fetch fails
      
      - name: Display Odds Summary
        run: |
          if [ -f "data/betting/live_odds_latest.csv" ]; then
            echo "âœ… Live odds fetched successfully"
            echo ""
            echo "ðŸ“Š Preview:"
            head -10 data/betting/live_odds_latest.csv
          else
            echo "âŒ No odds data found"
          fi
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Save the odds files we just created (before resetting)
          echo "ðŸ’¾ Saving newly created odds files..."
          mkdir -p /tmp/odds_backup
          cp -f data/betting/live_odds*.csv /tmp/odds_backup/ 2>/dev/null || true
          cp -f data/betting/*bookmakers*.csv /tmp/odds_backup/ 2>/dev/null || true
          
          # Reset to latest main to get latest code
          echo "ðŸ”„ Syncing with latest main..."
          git fetch origin main
          git reset --hard origin/main
          
          # Restore the odds files we just created
          echo "ðŸ“¥ Restoring odds files..."
          cp -f /tmp/odds_backup/*.csv data/betting/ 2>/dev/null || true
          
          # Add odds files (including bookmaker comparison)
          # Use explicit path to ensure bookmaker comparison file is added
          git add data/betting/live_odds*.csv 2>/dev/null || true
          git add data/betting/live_odds_bookmakers_comparison.csv 2>/dev/null || true
          git add data/betting/*bookmakers*.csv 2>/dev/null || true
          
          # Debug: Show what files are staged
          echo "ðŸ“‹ Files staged for commit:"
          git diff --staged --name-only || echo "No files staged"
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "âœ… No new odds data to commit"
          else
            # Check if bookmaker comparison file exists
            if [ -f "data/betting/live_odds_bookmakers_comparison.csv" ]; then
              echo "âœ… Bookmaker comparison file found and will be committed"
            else
              echo "âš ï¸ Bookmaker comparison file not found"
            fi
            
            # Commit the odds files
            git commit -m "ðŸŽ² Update live NBA betting odds: $(date +'%Y-%m-%d %H:%M UTC')
            
            Fetched from The Odds API
            - Live spreads, moneylines, totals
            - Bookmaker comparison data (vig analysis)
            - Updated for upcoming games
            
            [skip ci]"
            
            # Push - use force-with-lease for odds files since they're generated data
            echo "ðŸš€ Pushing changes..."
            # Try normal push first
            if git push origin main 2>&1 | grep -q "rejected\|failed"; then
              echo "âš ï¸ Normal push failed, using force-with-lease (safe for generated data)..."
              # Force push is safe here because odds files are generated data
              # and we always want the latest version
              git push origin main --force-with-lease || {
                echo "âš ï¸ Force-with-lease failed, fetching and retrying..."
                git fetch origin main
                git reset --hard origin/main
                # Restore our odds files
                cp -f /tmp/odds_backup/*.csv data/betting/ 2>/dev/null || true
                git add data/betting/live_odds*.csv data/betting/*bookmakers*.csv 2>/dev/null || true
                git commit -m "ðŸŽ² Update live NBA betting odds: $(date +'%Y-%m-%d %H:%M UTC')
            
            Fetched from The Odds API
            - Live spreads, moneylines, totals
            - Bookmaker comparison data (vig analysis)
            - Updated for upcoming games
            
            [skip ci]"
                git push origin main
              }
            fi
            echo "âœ… Live odds committed and pushed"
          fi
      
      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸŽ² Live Odds Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/betting/live_odds_latest.csv" ]; then
            GAMES_COUNT=$(tail -n +2 data/betting/live_odds_latest.csv | wc -l)
            echo "### âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "- Fetched odds for **${GAMES_COUNT}** upcoming NBA games" >> $GITHUB_STEP_SUMMARY
            echo "- Source: The Odds API" >> $GITHUB_STEP_SUMMARY
            echo "- Data saved to: \`data/betting/live_odds_latest.csv\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Failed" >> $GITHUB_STEP_SUMMARY
            echo "- Could not fetch live odds" >> $GITHUB_STEP_SUMMARY
            echo "- Check API key and credits" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Next Update" >> $GITHUB_STEP_SUMMARY
          echo "Scheduled in 6 hours" >> $GITHUB_STEP_SUMMARY

