name: Fetch Live NBA Odds

on:
  # Run every 6 hours during NBA season
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  
  # Allow manual trigger
  workflow_dispatch:

# Grant write permissions
permissions:
  contents: write

jobs:
  fetch-odds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: false
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests
      
      - name: Fetch Live Odds from The Odds API
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          echo "ðŸŽ² Fetching live NBA odds from The Odds API..."
          python scripts/data_collection/scrape_live_odds.py
        continue-on-error: false  # Fail if odds fetch fails
      
      - name: Display Odds Summary
        run: |
          if [ -f "data/betting/live_odds_latest.csv" ]; then
            echo "âœ… Live odds fetched successfully"
            echo ""
            echo "ðŸ“Š Preview:"
            head -10 data/betting/live_odds_latest.csv
          else
            echo "âŒ No odds data found"
          fi
      
      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add odds files
          git add data/betting/live_odds*.csv 2>/dev/null || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "âœ… No new odds data to commit"
          else
            git commit -m "ðŸŽ² Update live NBA betting odds: $(date +'%Y-%m-%d %H:%M UTC')
            
            Fetched from The Odds API
            - Live spreads, moneylines, totals
            - Updated for upcoming games
            
            [skip ci]"
            git push
            echo "âœ… Live odds committed and pushed"
          fi
      
      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸŽ² Live Odds Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/betting/live_odds_latest.csv" ]; then
            GAMES_COUNT=$(tail -n +2 data/betting/live_odds_latest.csv | wc -l)
            echo "### âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "- Fetched odds for **${GAMES_COUNT}** upcoming NBA games" >> $GITHUB_STEP_SUMMARY
            echo "- Source: The Odds API" >> $GITHUB_STEP_SUMMARY
            echo "- Data saved to: \`data/betting/live_odds_latest.csv\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Failed" >> $GITHUB_STEP_SUMMARY
            echo "- Could not fetch live odds" >> $GITHUB_STEP_SUMMARY
            echo "- Check API key and credits" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Next Update" >> $GITHUB_STEP_SUMMARY
          echo "Scheduled in 6 hours" >> $GITHUB_STEP_SUMMARY

