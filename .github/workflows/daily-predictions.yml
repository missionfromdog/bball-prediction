name: Daily NBA Predictions

on:
  schedule:
    # Run at 9 AM UTC (1 AM PST / 4 AM EST) before games typically start
    - cron: '0 9 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

# Grant write permissions
permissions:
  contents: write

jobs:
  make-predictions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: false  # DISABLE LFS to avoid bandwidth issues

      - name: Download best model (bypass LFS)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ MODEL SETUP"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          mkdir -p models
          
          # Check if model exists and if it's an LFS pointer
          if [ -f "models/histgradient_vegas_calibrated.pkl" ]; then
            echo "ğŸ“„ Found existing file, checking if it's LFS pointer..."
            if head -1 models/histgradient_vegas_calibrated.pkl 2>/dev/null | grep -q "version https://git-lfs"; then
              echo "âš ï¸  File is LFS pointer ($(wc -c < models/histgradient_vegas_calibrated.pkl) bytes)"
              echo "ğŸ”„ Downloading actual model file..."
              
              # Try multiple download methods
              SUCCESS=false
              
              # Method 1: GitHub media URL (for LFS)
              echo "Trying GitHub media URL..."
              if curl -L --fail --progress-bar \
                "https://media.githubusercontent.com/media/missionfromdog/bball-prediction/main/models/histgradient_vegas_calibrated.pkl" \
                -o models/histgradient_vegas_calibrated.pkl.tmp 2>&1; then
                mv models/histgradient_vegas_calibrated.pkl.tmp models/histgradient_vegas_calibrated.pkl
                SUCCESS=true
                echo "âœ… Downloaded from GitHub media URL"
              else
                echo "âŒ GitHub media URL failed"
              fi
              
              # Method 2: Try raw.githubusercontent.com (for non-LFS)
              if [ "$SUCCESS" = false ]; then
                echo "Trying raw.githubusercontent.com..."
                if curl -L --fail --progress-bar \
                  "https://raw.githubusercontent.com/missionfromdog/bball-prediction/main/models/histgradient_vegas_calibrated.pkl" \
                  -o models/histgradient_vegas_calibrated.pkl.tmp 2>&1; then
                  mv models/histgradient_vegas_calibrated.pkl.tmp models/histgradient_vegas_calibrated.pkl
                  SUCCESS=true
                  echo "âœ… Downloaded from raw.githubusercontent.com"
                else
                  echo "âŒ raw.githubusercontent.com failed"
                fi
              fi
              
              if [ "$SUCCESS" = false ]; then
                echo "âŒ All download methods failed!"
                echo "Will try to use local training instead..."
              fi
            else
              echo "âœ… File is already valid (not LFS pointer)"
            fi
          else
            echo "âŒ No model file found at all!"
            echo "Will need to train or download..."
          fi
          
          # Final check
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -f "models/histgradient_vegas_calibrated.pkl" ]; then
            FILE_SIZE=$(wc -c < models/histgradient_vegas_calibrated.pkl)
            echo "ğŸ“Š Final model file size: ${FILE_SIZE} bytes"
            
            # LFS pointer files are tiny (< 200 bytes), real models are 2-3 MB
            if [ "$FILE_SIZE" -lt 1000 ]; then
              echo "âš ï¸  WARNING: File is suspiciously small (probably still LFS pointer)"
              echo "Model loading will likely fail..."
            else
              echo "âœ… Model file looks good!"
            fi
          else
            echo "âŒ No model file present!"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn==1.3.0 xgboost lightgbm joblib
      
      - name: Make Daily Predictions
        run: |
          echo "ğŸ¯ Making predictions for today's NBA games..."
          python scripts/predictions/make_daily_predictions.py
        continue-on-error: false
      
      - name: Commit Predictions
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add prediction files
          git add data/predictions/*.csv 2>/dev/null || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "âœ… No games to predict today (or predictions unchanged)"
          else
            git commit -m "ğŸ¯ Daily NBA predictions: $(date +'%Y-%m-%d')
            
            Automated predictions for today's games
            - Model: HistGradient + Vegas (70.20% AUC)
            - Includes confidence levels
            - Matched with live odds when available
            
            [skip ci]"
            git push
            echo "âœ… Predictions committed and pushed"
          fi
      
      - name: Create Summary
        if: always()
        run: |
          echo "## ğŸ¯ Daily Predictions Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/predictions/predictions_latest.csv" ]; then
            GAMES_COUNT=$(tail -n +2 data/predictions/predictions_latest.csv | wc -l)
            echo "### âœ… Predictions Made" >> $GITHUB_STEP_SUMMARY
            echo "- Predicted **${GAMES_COUNT}** games for today" >> $GITHUB_STEP_SUMMARY
            echo "- Model: HistGradient + Vegas (70.20% AUC)" >> $GITHUB_STEP_SUMMARY
            echo "- File: \`data/predictions/predictions_latest.csv\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“Š Preview" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -5 data/predictions/predictions_latest.csv >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No Games Today" >> $GITHUB_STEP_SUMMARY
            echo "No NBA games scheduled or predictions failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”„ Next Prediction" >> $GITHUB_STEP_SUMMARY
          echo "Tomorrow at 9:00 AM UTC" >> $GITHUB_STEP_SUMMARY

