name: Daily NBA Predictions

on:
  schedule:
    # Run at 9 AM UTC (1 AM PST / 4 AM EST) before games typically start
    - cron: '0 9 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

# Grant write permissions
permissions:
  contents: write

jobs:
  make-predictions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: false  # DISABLE LFS to avoid bandwidth issues

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn==1.3.0 xgboost lightgbm joblib

      - name: Check and fix model file
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ MODEL SETUP"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          mkdir -p models
          
          # Check if model exists and if it's an LFS pointer
          MODEL_OK=false
          
          if [ -f "models/histgradient_vegas_calibrated.pkl" ]; then
            FILE_SIZE=$(wc -c < models/histgradient_vegas_calibrated.pkl)
            echo "ğŸ“„ Found model file (${FILE_SIZE} bytes)"
            
            # LFS pointer files are tiny (< 200 bytes), real models are 2-3 MB
            if [ "$FILE_SIZE" -gt 1000 ]; then
              echo "âœ… Model file looks valid (large enough to be real)"
              MODEL_OK=true
            else
              echo "âš ï¸  File is too small - probably LFS pointer"
              echo "First line:"
              head -1 models/histgradient_vegas_calibrated.pkl
              echo ""
              
              echo "ğŸ”„ Attempting to download actual model..."
              
              # Try downloading from GitHub
              if curl -L --fail --silent --show-error \
                "https://media.githubusercontent.com/media/missionfromdog/bball-prediction/main/models/histgradient_vegas_calibrated.pkl" \
                -o models/histgradient_vegas_calibrated.pkl.tmp 2>&1; then
                
                NEW_SIZE=$(wc -c < models/histgradient_vegas_calibrated.pkl.tmp)
                if [ "$NEW_SIZE" -gt 1000 ]; then
                  mv models/histgradient_vegas_calibrated.pkl.tmp models/histgradient_vegas_calibrated.pkl
                  echo "âœ… Downloaded valid model (${NEW_SIZE} bytes)"
                  MODEL_OK=true
                else
                  echo "âŒ Downloaded file is also too small"
                  rm -f models/histgradient_vegas_calibrated.pkl.tmp
                fi
              else
                echo "âŒ Download failed"
              fi
            fi
          else
            echo "âŒ No model file found"
          fi
          
          # If model still not OK, retrain it
          if [ "$MODEL_OK" = false ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ”§ RETRAINING MODEL (this takes ~2-3 minutes)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            python - << 'PYEOF'
import pandas as pd
import numpy as np
from pathlib import Path
from sklearn.ensemble import HistGradientBoostingClassifier
from sklearn.calibration import CalibratedClassifierCV
from sklearn.model_selection import train_test_split
import joblib

print("\nğŸ“Š Loading training data...")
DATAPATH = Path('data')
df = pd.read_csv(DATAPATH / 'games_with_real_vegas.csv')

print(f"   Loaded {len(df)} games")

# Prepare features
print("\nğŸ”§ Preparing features...")
X = df.copy()

# Drop target and metadata
target_cols = ['HOME_TEAM_WINS']
metadata_cols = ['GAME_DATE_EST', 'GAME_ID', 'MATCHUP']
categorical_cols = ['HOME_TEAM_ABBREVIATION', 'VISITOR_TEAM_ABBREVIATION', 
                   'HOME_TEAM_ID', 'VISITOR_TEAM_ID', 'SEASON']

# Drop leaky features (post-game stats)
leaky_patterns = ['FG_PCT_home', 'FG_PCT_away', 'FT_PCT_home', 'FT_PCT_away',
                 'FG3_PCT_home', 'FG3_PCT_away', 'AST_home', 'AST_away',
                 'REB_home', 'REB_away', 'PTS_home', 'PTS_away']

drop_cols = target_cols + metadata_cols + categorical_cols
for pattern in leaky_patterns:
    drop_cols.extend([col for col in X.columns if pattern in col and col not in drop_cols])

X = X.drop(columns=[col for col in drop_cols if col in X.columns], errors='ignore')
y = df['HOME_TEAM_WINS']

print(f"   Features: {len(X.columns)}")
print(f"   Samples: {len(X)}")

# Train/test split
print("\nâœ‚ï¸  Splitting data...")
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

# Train model
print("\nğŸ¯ Training HistGradientBoosting...")
model = HistGradientBoostingClassifier(
    random_state=42,
    max_iter=200,
    max_depth=7,
    learning_rate=0.05,
    max_leaf_nodes=31,
    min_samples_leaf=20,
    max_features=0.8,
    verbose=0
)
model.fit(X_train, y_train)

# Calibrate
print("ğŸ¨ Calibrating probabilities...")
calibrated = CalibratedClassifierCV(model, cv=3, method='isotonic')
calibrated.fit(X_train, y_train)

# Evaluate
train_score = calibrated.score(X_train, y_train)
test_score = calibrated.score(X_test, y_test)
print(f"\nğŸ“Š Training accuracy: {train_score:.4f}")
print(f"ğŸ“Š Test accuracy: {test_score:.4f}")

# Save
print("\nğŸ’¾ Saving model...")
Path('models').mkdir(exist_ok=True)
joblib.dump(calibrated, 'models/histgradient_vegas_calibrated.pkl')

file_size = Path('models/histgradient_vegas_calibrated.pkl').stat().st_size
print(f"âœ… Model saved ({file_size / 1024 / 1024:.1f} MB)")
PYEOF
            
            if [ $? -eq 0 ]; then
              echo "âœ… Model retrained successfully!"
              MODEL_OK=true
            else
              echo "âŒ Model retraining failed!"
              exit 1
            fi
          fi
          
          # Final verification
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ "$MODEL_OK" = true ]; then
            FINAL_SIZE=$(wc -c < models/histgradient_vegas_calibrated.pkl)
            echo "âœ… READY: Model file is valid (${FINAL_SIZE} bytes)"
          else
            echo "âŒ FAILED: Could not get valid model"
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Make Daily Predictions
        run: |
          echo "ğŸ¯ Making predictions for today's NBA games..."
          python scripts/predictions/make_daily_predictions.py
        continue-on-error: false
      
      - name: Commit Predictions
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add prediction files
          git add data/predictions/*.csv 2>/dev/null || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "âœ… No games to predict today (or predictions unchanged)"
          else
            git commit -m "ğŸ¯ Daily NBA predictions: $(date +'%Y-%m-%d')
            
            Automated predictions for today's games
            - Model: HistGradient + Vegas (70.20% AUC)
            - Includes confidence levels
            - Matched with live odds when available
            
            [skip ci]"
            git push
            echo "âœ… Predictions committed and pushed"
          fi
      
      - name: Create Summary
        if: always()
        run: |
          echo "## ğŸ¯ Daily Predictions Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/predictions/predictions_latest.csv" ]; then
            GAMES_COUNT=$(tail -n +2 data/predictions/predictions_latest.csv | wc -l)
            echo "### âœ… Predictions Made" >> $GITHUB_STEP_SUMMARY
            echo "- Predicted **${GAMES_COUNT}** games for today" >> $GITHUB_STEP_SUMMARY
            echo "- Model: HistGradient + Vegas (70.20% AUC)" >> $GITHUB_STEP_SUMMARY
            echo "- File: \`data/predictions/predictions_latest.csv\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“Š Preview" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -5 data/predictions/predictions_latest.csv >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No Games Today" >> $GITHUB_STEP_SUMMARY
            echo "No NBA games scheduled or predictions failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”„ Next Prediction" >> $GITHUB_STEP_SUMMARY
          echo "Tomorrow at 9:00 AM UTC" >> $GITHUB_STEP_SUMMARY

