name: Daily NBA Predictions

on:
  schedule:
    # Run at 9 AM UTC (1 AM PST / 4 AM EST) before games typically start
    - cron: '0 9 * * *'
  
  # Allow manual trigger
  workflow_dispatch:

# Grant write permissions
permissions:
  contents: write

jobs:
  make-predictions:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          lfs: false  # DISABLE LFS to avoid bandwidth issues

      - name: Download model from local file (bypass LFS)
        run: |
          echo "ðŸ“¦ Setting up model directory..."
          mkdir -p models
          
          # Copy model from local repo if it exists and isn't LFS pointer
          if [ -f "models/histgradient_vegas_calibrated.pkl" ]; then
            if head -1 models/histgradient_vegas_calibrated.pkl 2>/dev/null | grep -q "version https://git-lfs"; then
              echo "âš ï¸  Model is LFS pointer, downloading from alternate source..."
              # Download directly from your fork's raw file (GitHub serves actual content)
              curl -L "https://media.githubusercontent.com/media/missionfromdog/bball-prediction/main/models/histgradient_vegas_calibrated.pkl" \
                -o models/histgradient_vegas_calibrated.pkl || \
              echo "Note: Could not download from GitHub raw, model may need manual upload"
            else
              echo "âœ… Model file is already valid"
            fi
          fi
          
          ls -lh models/histgradient_vegas_calibrated.pkl || echo "Model file not found"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn==1.3.0 xgboost lightgbm joblib
      
      - name: Make Daily Predictions
        run: |
          echo "ðŸŽ¯ Making predictions for today's NBA games..."
          python scripts/predictions/make_daily_predictions.py
        continue-on-error: false
      
      - name: Commit Predictions
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add prediction files
          git add data/predictions/*.csv 2>/dev/null || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "âœ… No games to predict today (or predictions unchanged)"
          else
            git commit -m "ðŸŽ¯ Daily NBA predictions: $(date +'%Y-%m-%d')
            
            Automated predictions for today's games
            - Model: HistGradient + Vegas (70.20% AUC)
            - Includes confidence levels
            - Matched with live odds when available
            
            [skip ci]"
            git push
            echo "âœ… Predictions committed and pushed"
          fi
      
      - name: Create Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Daily Predictions Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/predictions/predictions_latest.csv" ]; then
            GAMES_COUNT=$(tail -n +2 data/predictions/predictions_latest.csv | wc -l)
            echo "### âœ… Predictions Made" >> $GITHUB_STEP_SUMMARY
            echo "- Predicted **${GAMES_COUNT}** games for today" >> $GITHUB_STEP_SUMMARY
            echo "- Model: HistGradient + Vegas (70.20% AUC)" >> $GITHUB_STEP_SUMMARY
            echo "- File: \`data/predictions/predictions_latest.csv\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Preview" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -5 data/predictions/predictions_latest.csv >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ No Games Today" >> $GITHUB_STEP_SUMMARY
            echo "No NBA games scheduled or predictions failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Next Prediction" >> $GITHUB_STEP_SUMMARY
          echo "Tomorrow at 9:00 AM UTC" >> $GITHUB_STEP_SUMMARY

